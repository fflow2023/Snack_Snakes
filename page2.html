<!DOCTYPE html>
<html>
<head>
    <h1>游戏结束!</h1>
<script>
var urlParams = new URLSearchParams(window.location.search);
var scores = urlParams.get('scores');

if (scores) {
  document.write('你的得分是: ' + scores + '！');
} else {
  document.write('未传递参数scores。');
}
</script>

      <meta charset="UTF-8">
    <title>Scoreboard</title>
    <script>
        // 接收表单提交的函数
        function submitForm() {
            var name = document.getElementById("name").value;
            if (name === "") {
              name = "Unnamed";
            }
            var score = scores;
            // 使用fetch发送POST请求给GitHub API
            fetch('https://api.github.com/repos/fflow2023/fflow2023.GitHub.io/contents/scores.json', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer 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'
                }
            })
            .then(response => response.json())
            .then(data => {
                var scores = JSON.parse(atob(data.content));
                
                // 添加新得分数据
                scores.push({ "name": name, "score": score });
                
                // 将更新后的得分数据提交到GitHub仓库
                fetch('https://api.github.com/repos/fflow2023/fflow2023.GitHub.io/contents/scores.json', {
                    method: 'PUT',
                    headers: {
                        'Authorization': 'Bearer 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',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        "message": "Update scores.json",
                        "content": btoa(JSON.stringify(scores)),
                        "sha": data.sha
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Score submitted successfully!");
                    // 在此处更新排行榜显示
                })
                .catch(error => console.error(error));
            })
            .catch(error => console.error(error));
        }
        
        // 获取排行榜数据并更新显示的函数
        function updateLeaderboard() {
            fetch('https://api.github.com/repos/fflow2023/fflow2023.GitHub.io/contents/scores.json', {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer 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'
                }
            })
            .then(response => response.json())
            .then(data => {
                var scores = JSON.parse(atob(data.content));
                
                // 根据得分进行排序
                scores.sort(function(a, b) {
                    return b.score - a.score;
                });
                
                // 更新排行榜显示
                var leaderboard = document.getElementById("leaderboard");
                leaderboard.innerHTML = "";
                for (var i = 0; i < scores.length; i++) {
                    var row = document.createElement("tr");
                    var rankCell = document.createElement("td");
                    var nameCell = document.createElement("td");
                    var scoreCell = document.createElement("td");
                    rankCell.textContent = i + 1;
                    nameCell.textContent = scores[i].name;
                    scoreCell.textContent = scores[i].score;
                    row.appendChild(rankCell);
                    row.appendChild(nameCell);
                    row.appendChild(scoreCell);
                    leaderboard.appendChild(row);
                }
            })
            .catch(error => console.error(error));
        }
        function restrictInput(input) {
        // 移除非法字符
        var regex = /[^a-zA-Z0-9_\s]/g;
        input.value = input.value.replace(regex, '');

        // 检查输入的长度是否超过12个字符
        if (input.value.length > 12 ) {
          input.value = input.value.substring(0, 12);
        }
}

    </script>
</head>
<body>
    <h1>上传你的分数</h1>
    <form>
        <label for="name">姓名：</label>
        <input type="text" id="name" oninput="restrictInput(this)" required><br><br>
        <body>
      <script>
        document.write('得分: ' + scores );
      </script>
        <br><br><input type="button" value="提交" onclick="clickit()"> （需要不低于5分）
    </form>
    <h2>排行榜</h2> →<button onclick="goToIndex()">返回首页</button>←
    <table id="leaderboard">
        <tr>
            <th> 排名 </th>
            <th> 姓名 </th>
            <th> 得分 </th>
            <br>
        </tr>
    </table>
    <div id="overlay" onclick="hidePopup()">
        <div id="modal"></div>
    </div>
    <style>
        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        
        #modal {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            text-align: center;
        }
    </style>
    <script>
        // 页面加载完毕后更新排行榜显示
        window.onload = updateLeaderboard;
        function goToIndex() {
         window.location.href = "index.html";
        }
        //点击按钮后判断
        function clickit(){
        if(scores < 0)
             showPopupB();
          if(scores < 5 && scores>=0)
            showPopupA();
          if(scores>=5){
            submitForm();
            alert("上传成功，刷新试试吧!");
            window.location.href = "page2.html?scores="+-1;
          }
        }
        // 点击按钮后显示弹出框的函数
        function showPopup() { 
            var overlay = document.getElementById("overlay");
            var modal = document.getElementById("modal");
            overlay.style.display = "flex";
            modal.textContent = "上传成功，刷新试试吧";
        }
        
        // 点击按钮后显示弹出框的函数
        function showPopupA() {
            var overlay = document.getElementById("overlay");
            var modal = document.getElementById("modal");
            overlay.style.display = "flex";
            modal.textContent = "分数太低了，就别丢人了吧";
        }
            // 点击按钮后显示弹出框的函数
            function showPopupB() {
            var overlay = document.getElementById("overlay");
            var modal = document.getElementById("modal");
            overlay.style.display = "flex";
            modal.textContent = "你已经提交过了哦";
        }
        // 隐藏弹出框的函数
        function hidePopup() {
            var overlay = document.getElementById("overlay");
            overlay.style.display = "none";
        }
    </script>
   </script>
</body>
</html>
